#!/usr/bin/env bash
set -euo pipefail

DIR="${1:-.}"
DIR="$(realpath "$DIR")"
BASENAME="$(basename "$DIR")"
OUTPUT="$DIR/$BASENAME.m4b"

TMPFILE="$(mktemp)"

find "$DIR" -maxdepth 1 -type f -iname "*.m4b" -print0 \
  | sort -z \
  | while IFS= read -r -d '' file; do
        printf "file '%s'\n" "$file"
    done > "$TMPFILE"

ffmpeg -f concat -safe 0 -i "$TMPFILE" -c:a aac -b:a 128k "$OUTPUT"

rm "$TMPFILE"

echo "Created: $OUTPUT"
