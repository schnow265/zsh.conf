#!/bin/bash
set -eo pipefail

clone_dir="$HOME/Documents/clones/"
repo_dir="$clone_dir/llama.cpp"

mkdir -p "$clone_dir"
cd "$clone_dir"

if [ -d "$repo_dir" ]; then
    cd "$repo_dir"
    git pull
else
    git clone git@github.com:ggml-org/llama.cpp.git
    cd "$repo_dir"
fi

source ~/vulkan/1.4.335.0/setup-env.sh

CC=clamg CXX=clang++ HIPCXX="$(hipconfig -l)/clang" HIP_PATH="$(hipconfig -R)" \
    cmake -S . \
    -B build \
    -D CMAKE_C_COMPILER_LAUNCHER=ccache \
    -D CMAKE_CXX_COMPILER_LAUNCHER=ccache \
    -D GGML_HIP=OFF \
    -D GGML_HIP_ROCWMMA_FATTN=ON \
    -D GGML_BLAS=ON \
    -D GGML_BLAS_VENDOR=OpenBLAS \
    -D GGML_VULKAN=ON \
    -D AMDGPU_TARGETS=gfx1030 \
    -D CMAKE_BUILD_TYPE=Release \
    -D CMAKE_INSTALL_PREFIX=/home/schnow265/.local/ \
    -D CMAKE_CXX_FLAGS="-march=native -O3" \
    -D CMAKE_CC_FLAGS="-march=native -O3" \
    -D CMAKE_EXE_LINKER_FLAGS="-flto=thin" \
    -G Ninja

cmake --build build --config Release --target install
